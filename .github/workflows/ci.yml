name: Pydoc unittest  CI

on:
  push:
    #pull_request:
    tags:
    #- 'v*' # Push events to matching v*, i.e. v1.0, v20.15.10
    branches: [master]
    

jobs:
   
  env:
   runs-on: ubuntu-latest
   steps:
   - name: "üîß env"
     run : env 
   - name: "üîß ls -alrt"
     run:  ls -alrt
   - name: "üîß pwd"
     run:  pwd
   


  checkout:
    runs-on: ubuntu-latest
    needs: env
    permissions:
      contents: write
      issues: read
      deployments: write
    steps:
    - name : "‚òÅÔ∏è checkout repo"
      uses: actions/checkout@v3

    - name: "üîç affiche variables"
      run: |
        echo GITHUB_WORKSPACE: $GITHUB_WORKSPACE GITHUB_ACTION_REPOSITORY: $GITHUB_ACTION_REPOSITORY GIT_DIR: $GIT_DIR  GIT_WORK_TREE: $GIT_WORK_TREE \
             GITHUB_PATH: $GITHUB_PATH GITHUB_OUTPUT: $GITHUB_OUTPUT
    - name: "üì¶ genere doc  (pydoc3 -w src/calc.py)"
      #working-directory: ./calc/
      run: |
        pydoc3 -w src/calc.py
        GITHUB_OUTPUT=$(pydoc3 src/calc.py)
        
	echo $GITHUB_OUTPUT
        touch calc.html
        echo koko 
        IFS=""
        DOC=$(echo $GITHUB_OUPUT | sed -e 's/^NAME/# &/'  -e 's/^DESCRIPTION/## &/' -e 's/^FUNCTIONS/### &/' -e 's/^FILE/#### &/')
        echo $DOC >doc.md
 
        for item in $(echo $GITHUB_OUTPUT); do echo $item; done       
        echo $GITHUB_OUTPUT | sed -e 's/^NAME/# &/' \
        -e 's/^DESCRIPTION/## &/' \
        -e 's/^FUNCTIONS/### &/' \
        -e 's/^FILE/#### &/' \
        -e 's/^\([0-9]\+\.\) /* &/' \
        -e 's/^\* /* &/' 
        unset IFS


    - name: "üîç run tests in dir tests  (python -m unittest  discover tests)"
      run: python -m unittest  discover   tests
    
    - name: "üîç env variable pwd"
      run: pwd && ls -altr && echo ${GITHUB_WORKSPACE} 
  
    - name: Setup Git
      run: |
        git config user.name 'Fab Reno'
        git config user.email 'github@stock.eu.org'
        # git config gpg.format ssh
        # git config user.signingKey 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIHnlMYthrlF2PhdLMI78hMx51wq0l8P2L82JOaOLwQ81 fab@localhost'

    - name: Add doc 
      run: |
        touch calc.html
        touch doc.md
        git add calc.html
        git commit -m "cal.html documentation pydoc3"
        git push origin master 

